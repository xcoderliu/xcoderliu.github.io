---
layout: post
title: Shell ÁºñÁ®ãÂÆûË∑µ
tag: shell
date: 2017-02-20 09:14:00.000000000 +09:00
---

### Â≠êÊñá‰ª∂Â§π

```
subFolders=`find $parentFolder -type d -maxdepth 1 -mindepth 1`
```

### ËøõÂ∫¶Êù°

```
function ProgressBar {
# Process data
let _progress=(${1}*100/${2}*100)/100
let _done=(${_progress}*4)/10
let _left=40-$_done
# Build progressbar string lengths
_fill=$(printf "%${_done}s")
_empty=$(printf "%${_left}s")

printf "\rProgress : [${_fill// /#}${_empty// /-}] ${_progress}%%"

}
```

### shell ÂÆûÊàòËÑöÊú¨ÊâìÂåÖ

```
projectPath=/Users/liuzhimin/Dropbox/Personal?Code/Project
thearchviePath=/Users/liuzhimin/Desktop
ipaPath=/Users/liuzhimin/Desktop
projectname=PackageProject
resourcefolder=res_dev
version=$1

cd $projectPath

######copy Dev file######
echo "üòÄ  üòÄ  üòÄ  i will start for development package!"
echo "***************** copy Dev public file start *****************"

cp -rf $projectPath/$resourcefolder/AppIcon.appiconset $projectPath/ProjectClient/Images.xcassets

cp -rf $projectPath/$resourcefolder/InfoPlist.strings/*.lproj $projectPath/ProjectClient/

cp -rf $projectPath/$resourcefolder/Localizable.strings/*.lproj $projectPath/Resources/

cp -rf $projectPath/$resourcefolder/Multiversion  $projectPath/ProjectClient/Images.xcassets

cp -rf $projectPath/$resourcefolder/ProjectClient-InfoDev.plist  $projectPath/ProjectClient/ProjectClient-Info.plist

cp -rf $projectPath/$resourcefolder/configDev.xml  $projectPath/ProjectClient/config.xml

cp -rf $projectPath/$resourcefolder/ClientMgrCfgDev.xml  $projectPath/ProjectClient/meetingMgrCfg.xml

echo "***************** copy Dev over *****************"


######start Dev bulild######
echo "***************** start clean Dev workspace *****************"

xcodebuild clean

rm -rf $thearchviePath/ProjectApp.xcarchive

rm -rf $thearchviePath/ProjectDev.xcarchive

rm -rf $thearchviePath/ProjectIntranet.xcarchive

rm -rf $ipaPath/Project_for_iOS_${version}_test.ipa

rm -rf $ipaPath/Project_for_iOS_${version}_appstore.ipa

rm -rf $ipaPath/Project_for_iOS_${version}_appstore_test.ipa

xcodebuild -project $projectname.xcodeproj -scheme $projectname -configuration Release clean

echo "***************** clean Dev workspace over *****************"

echo "***************** start build Dev workspace *****************"

xcodebuild -project $projectname.xcodeproj -scheme $projectname -configuration Release

echo "***************** build Dev workspace over *****************"

echo "***************** start export Dev archive *****************"

xcodebuild -project $projectname.xcodeproj -scheme $projectname archive -archivePath $thearchviePath/ProjectDev.xcarchive

echo "***************** export Dev archive over *****************"

echo "***************** start export Dev ipa app *****************"

xcodebuild -exportArchive -archivePath $thearchviePath/ProjectDev.xcarchive -exportPath $ipaPath -exportOptionsPlist projectDev.plist

mv $ipaPath/ProjectClient.ipa $ipaPath/Project_for_iOS_ ${version}_test.ipa

echo "***************** export Dev ipa over *****************"


###### Intranet test package ######
echo "üòÇ  üòÇ  üòÇ  now Intranet test package!"
cp -rf $projectPath/$resourcefolder/configIntranet.xml  $projectPath/ProjectClient/config.xml

cp -rf $projectPath/$resourcefolder/meetingMgrCfgIntranet.xml  $projectPath/ProjectClient/meetingMgrCfg.xml

#xcodebuild -project $projectname.xcodeproj -scheme $projectname -configuration Release

xcodebuild -project $projectname.xcodeproj -scheme $projectname archive -archivePath $thearchviePath/ProjectIntranet.xcarchive

xcodebuild -exportArchive -archivePath $thearchviePath/ProjectDev.xcarchive -exportPath $ipaPath -exportOptionsPlist projectDev.plist

mv $ipaPath/ProjectClient.ipa $ipaPath/Project_for_iOS_${version}_Intranet_test.ipa

######copy App file######
echo "üòÇ  üòÇ  üòÇ  then App & APP test package!"
echo "***************** copy App public file start *****************"

cp -rf $projectPath/$resourcefolder/configApp.xml  $projectPath/ProjectClient/config.xml

cp -rf $projectPath/$resourcefolder/meetingMgrCfgApp.xml  $projectPath/ProjectClient/meetingMgrCfg.xml

cp -rf $projectPath/$resourcefolder/ProjectClient-InfoApp.plist  $projectPath/ProjectClient/ProjectClient-Info.plist

echo "***************** copy App over *****************"

echo "***************** start build App workspace *****************"

#xcodebuild -project $projectname.xcodeproj -scheme $projectname -configuration Release

echo "***************** build App workspace over *****************"

echo "***************** start export App archive *****************"

xcodebuild -project $projectname.xcodeproj -scheme $projectname archive -archivePath $thearchviePath/ProjectApp.xcarchive

echo "***************** export App archive over *****************"

echo "***************** start export App ipa app *****************"

xcodebuild -exportArchive -archivePath $thearchviePath/ProjectDev.xcarchive -exportPath $ipaPath -exportOptionsPlist projectRelease.plist

mv $ipaPath/ProjectClient.ipa $ipaPath/Project_for_iOS_${version}_appstore.ipa

xcodebuild -exportArchive -archivePath $thearchviePath/ProjectDev.xcarchive -exportPath $ipaPath -exportOptionsPlist projectDev.plist

mv $ipaPath/ProjectClient.ipa $ipaPath/Project_for_iOS_${version}_appstore_test.ipa

echo "***************** export App ipa over *****************"

```

### shell ÂÆûÊàòËÑöÊú¨ÂàÜÊûêxcodeÂ¥©Ê∫ÉÊó•Âøó

```
shortVersion=3.10.5
longVersion=03.10.5.0
logDirPath="/Users/liuzhimin/Library/Developer/Xcode/Products/com.inpor.Projectcloudios/${shortVersion}?(${longVersion})/Crashes/AppStore/"
outPutFile="/Users/liuzhimin/Desktop/CrashLog/CrashAnalyse.log"

#ËøõÂ∫¶Êù°ÂáΩÊï∞
function ProgressBar {
    # Process data
    let _progress=(${1}*100/${2}*100)/100
    let _done=(${_progress}*4)/10
    let _left=40-$_done
    # Build progressbar string lengths
    _fill=$(printf "%${_done}s")
    _empty=$(printf "%${_left}s")
    printf "\rÊó•ÂøóÂàÜÊûêËøõÂ∫¶ : [${_fill// /#}${_empty// /-}] ${_progress}%%"
}

#Êï∞ÁªÑÊòØÂê¶ÂåÖÂê´ÂáΩÊï∞
function array_containsSubString () {
    local seeking=$1; shift
    local in=1
    for element;
    do
        if [[ "$seeking" == *"$element"* ]]; then
            in=0
            break
        fi
    done
echo $in
}

# ÂÆ¢Êà∑Á´ØÂ¥©Ê∫ÉÁ±ªÂûãÔºö

declare -a clientCrashArr=(
"Project: -[VNCViewController pinchView:]"
"Project: -[ConfMainViewController chatBtnTap:]"
"AudioToolbox: "
"UIKit:"
"MobileCoreServices"
)

# Á≥ªÁªüÂ¥©Ê∫ÉÁ±ªÂûãÔºö

declare -a libCrashArr=(
"libsystem_kernel.dylib: __pthread_kill"
"Project: -[WBPageInnerUIView drawRect:]"
"Project: -[MeetingRoomStateAdaptor UserAudioState:bID:bState:]"
"Project: -[VideoDeviceAdaptor writeVideoSample:buffer:bufferSize:]"
"AGXGLDriver:"
"Project: -[WBPageInnerUIView drawRect:]"
"GLEngine: gliPresentViewES_Exec"
"Project: ff_h264_decode_nal"
"Project: WBASELIB::WMsgQueue<HandlerMsg>::PushMsg(HandlerMsg*, unsigned int*)"
"Project: -[PopoverSheetViewController largeScreen:]"
"Project: std::__1::__tree<std::__1::__value_type<unsigned int, unsigned int>, std::__1::__map_value_compare<unsigned int, std::__1::__value_type<unsigned int, unsigned int>, std::__1::less<unsigned int>, true>, std::__1::allocator<std::__1::__value_type<unsigned int, unsigned int> > >::__node_insert_unique(std::__1::__tree_node<std::__1::__value_type<unsigned int, unsigned int>, void*>*)"
"Project: -[VideoCapture prepareWithWidth:andHeight:andFps:]"
"-[AVCtrl pauseRecvAllAudio:]"
"WNET_NETWORK::CSockWorkThread::ThreadProcEx()"
"IMGSGX554GLDriver"
"AGXMetalA10"
"[WhiteBoardViewController updateWBAccessMode]"
"[MultiWhiteBoardAdaptor setAccessMode:]"
)




cd ${logDirPath}
echo "üìÇ ÊâìÂºÄÊó•ÂøóÊñá‰ª∂Â§π ËøõË°åÊâ´Êèè"

crashFoderPaths=`find ./ -type d -maxdepth 1 -mindepth 1`
rm -rf $outPutFile
echo "üö´ remove old analyse log"
sleep 0.5s

touch $outPutFile
echo "üìÉ ÂàõÂª∫Êñ∞ÁöÑÊó•ÂøóÂáÜÂ§áÂÜôÂÖ•"
sleep 0.5s

#Â¥©Ê∫ÉÁöÑÁ±ªÂûã‰∏™Êï∞
crashKindCounts=`find ./ -type d -maxdepth 1 -mindepth 1 | wc -l`

#ÊÄªÁöÑÂ¥©Ê∫É‰∏™Êï∞
allcrashCounts=0

for crashfolderPath in $crashFoderPaths
do
    #ËøõÂÖ•Âêå‰∏ÄÁ±ªÂ¥©Ê∫ÉÁªüËÆ°ÁöÑÊñá‰ª∂Â§π
    crashFolder=`basename $crashfolderPath`
    cd $crashFolder
    crashLogsCount=`find ./DistributionInfos/all/logs -type f -maxdepth 1 -mindepth 1 | wc -l`
    allcrashCounts=$(($allcrashCounts+$crashLogsCount))
    cd ..
done

#ÂºÄÂßãËØªÂèñÊó•Âøó
logStart=0
logEnd=$(($allcrashCounts))

#ÂÆ¢Êà∑Á´ØÂ¥©Ê∫É‰∏™Êï∞
clientCrashCounts=0
#ÊúçÂä°Âô®Á´ØÂ¥©Ê∫É‰∏™Êï∞
libCrashCounts=0
#ÂÆ¢Êà∑Á´ØÂ¥©Ê∫ÉÁ±ªÂûã‰∏™Êï∞
clientCrashKindCounts=0
#ÊúçÂä°Âô®Á´ØÂ¥©Ê∫ÉÁ±ªÂûã‰∏™Êï∞
libCrashKindCounts=0
#Á±ªÂûãÂÜ≤Á™ÅÂ¥©Ê∫É‰∏™Êï∞
errorCrashCounts=0
#Êú™Áü•Â¥©Ê∫É‰∏™Êï∞
unknownCrashCounts=0

for crashfolderPath in $crashFoderPaths
do
    #ËøõÂÖ•Âêå‰∏ÄÁ±ªÂ¥©Ê∫ÉÁªüËÆ°ÁöÑÊñá‰ª∂Â§π
    crashFolder=`basename $crashfolderPath`
    cd $crashFolder

    crashName=`cat Info.json | jq '.DefaultName'`
    echo Â¥©Ê∫ÉÂêç: ${crashName} >> $outPutFile

    crashLogsCount=`find ./DistributionInfos/all/logs -type f -maxdepth 1 -mindepth 1 | wc -l`
    echo Â¥©Ê∫ÉÊ¨°Êï∞: ${crashLogsCount} >> $outPutFile

    iscrashTop=`cat ./DistributionInfos/all/Info.json | jq '.IsTopCrash'`
    echo ÊòØÂê¶ÊéíË°åÈù†ÂâçÂ¥©Ê∫É: ${iscrashTop} >> $outPutFile

    #ÂÆ¢Êà∑Á´ØÂ¥©Ê∫É
    isClient=$(array_containsSubString "$crashName" "${clientCrashArr[@]}")
    isLib=$(array_containsSubString "$crashName" "${libCrashArr[@]}")

    if test $isClient -eq 0 && test $isLib -eq 1; then
        clientCrashCounts=$(($clientCrashCounts+$crashLogsCount))
        clientCrashKindCounts=$(($clientCrashKindCounts+1))
        echo Â¥©Ê∫ÉÁ±ªÂûã: ÂÆ¢Êà∑Á´ØÂ¥©Ê∫É >> $outPutFile
    fi


    if test $isLib -eq 0 && test $isClient -eq 1; then
        libCrashCounts=$(($libCrashCounts+$crashLogsCount))
        libCrashKindCounts=$(($libCrashKindCounts+1))
        echo Â¥©Ê∫ÉÁ±ªÂûã: Âπ≥Âè∞Â¥©Ê∫É >> $outPutFile
    fi

    if test $isClient -eq 0 && test $isLib -eq 0; then
        errorCrashCounts=$(($errorCrashCounts+$crashLogsCount))
        echo Â¥©Ê∫ÉÁ±ªÂûã: Á±ªÂûãÂÜ≤Á™Å >> $outPutFile
    fi


    if test $isLib -eq 1 && test $isClient -eq 1; then
        unknownCrashCounts=$(($unknownCrashCounts+$crashLogsCount))
        echo Â¥©Ê∫ÉÁ±ªÂûã: Êú™Áü•Â¥©Ê∫É >> $outPutFile
    fi

    echo  ""  >> $outPutFile

    logStart=$(($logStart+$crashLogsCount))
    ProgressBar ${logStart} $logEnd

    cd ..
done

echo

echo ÁªüËÆ°ÁªìÊûú:
echo ÊâÄÊúâÂ¥©Ê∫ÉÊÄª‰∏™Êï∞: $allcrashCounts
echo Â¥©Ê∫ÉÁ±ªÂûãÊÄª‰∏™Êï∞: $crashKindCounts
echo ÁªüËÆ°ÁªìÊûú:   >> $outPutFile
echo ÊâÄÊúâÂ¥©Ê∫ÉÊÄª‰∏™Êï∞: $allcrashCounts   >> $outPutFile
echo Â¥©Ê∫ÉÁ±ªÂûãÊÄª‰∏™Êï∞: $crashKindCounts >> $outPutFile
persents=`echo "scale=4; ($clientCrashCounts * 100 / $allcrashCounts )" | bc | awk '{printf "%.4f", $0}'`
echo ÂÆ¢Êà∑Á´ØÂ¥©Ê∫ÉÂÖ± $clientCrashCounts ‰∏™ÔºåÂ¥©Ê∫ÉÁ±ªÂûã $clientCrashKindCounts ‰∏™ÔºåÂç† $persents %
echo ÂÆ¢Êà∑Á´ØÂ¥©Ê∫É $clientCrashCounts ‰∏™ÔºåÂ¥©Ê∫ÉÁ±ªÂûã $clientCrashKindCounts ‰∏™ÔºåÂç† $persents %   >> $outPutFile
persents=`echo "scale=4; ($libCrashCounts * 100 / $allcrashCounts )" | bc | awk '{printf "%.4f", $0}'`
echo Âπ≥Âè∞Â¥©Ê∫ÉÂÖ± $libCrashCounts ‰∏™ÔºåÂ¥©Ê∫ÉÁ±ªÂûã $libCrashKindCounts ‰∏™ÔºåÂç† $persents %
echo Âπ≥Âè∞Â¥©Ê∫ÉÂÖ± $libCrashCounts ‰∏™ÔºåÂ¥©Ê∫ÉÁ±ªÂûã $libCrashKindCounts ‰∏™ÔºåÂç† $persents %   >> $outPutFile
persents=`echo "scale=4; ($errorCrashCounts * 100 / $allcrashCounts )" | bc | awk '{printf "%.4f", $0}'`
echo ÂÜ≤Á™ÅÂ¥©Ê∫É $errorCrashCounts ‰∏™ÔºåÂç† $persents %
echo ÂÜ≤Á™ÅÂ¥©Ê∫É $errorCrashCounts ‰∏™ÔºåÂç† $persents %   >> $outPutFile
persents=`echo "scale=4; ($unknownCrashCounts * 100 / $allcrashCounts )" | bc | awk '{printf "%.4f", $0}'`
echo Êú™Áü•Â¥©Ê∫É $unknownCrashCounts ‰∏™ÔºåÂç† $persents %
echo Êú™Áü•Â¥©Ê∫É $unknownCrashCounts ‰∏™ÔºåÂç† $persents %   >> $outPutFile

```

### shell ÂÆûÊàòÁ¨¶Âè∑ÂåñÂ¥©Ê∫ÉÊó•Âøó

```
#!/bin/bash

IFS=$'\n'

ARGS=("$@")

XCODE_DIR="/Applications/Xcode.app"
export DEVELOPER_DIR="${XCODE_DIR}/Contents/Developer"

XCODE_VERSION=$(defaults read /Applications/Xcode.app/Contents/version.plist CFBundleShortVersionString)

if [ ${XCODE_VERSION:0:1} == "6" ]; then
	CRASH="${XCODE_DIR}/Contents/SharedFrameworks/DTDeviceKitBase.framework/Versions/Current/Resources/symbolicatecrash"
else
	# test work on xcode7-8
	CRASH="${XCODE_DIR}/Contents/SharedFrameworks/DVTFoundation.framework/Versions/A/Resources/symbolicatecrash"
fi

function checkUUIDAndExec()
{
	LOG_PATH=$1
	APP_PATH=$2

	if [ $(echo "$APP_PATH" | grep "\.app\.dsym") ]; then
		# Find raw UUID when file is .app.dsym
		APP_UUID=$(dwarfdump --uuid $APP_PATH)
	elif [ $(echo "$APP_PATH" | grep "\.app") ]; then
		# Find raw UUID when file is .app
		# Find executable file name
		for i in $(ls "$APP_PATH"); do
			if [ $(echo "$i" | grep "\.") ]; then
				continue
			elif [ $(echo "$i" | grep "PkgInfo") ]; then
				continue
			elif [ $(echo "$i" | grep "_CodeSignature") ]; then
				continue
			else
				EXEC_NAME=$i
			fi
		done
		if [ "$EXEC_NAME"x = x ]; then
			echo "App name not found"
		fi
		APP_UUID=$(dwarfdump --uuid "$APP_PATH/$EXEC_NAME")
	else
		echo "App path $APP_PATH is not valid"
		return
	fi

	# Extract UUID from raw data
	for i in $(echo "$APP_UUID" | grep -Eo "UUID: [0-9a-fA-F\-]+ "); do
		if [[ "$i" = "UUID:" ]]; then
			continue
		else
			# Execute if lowercase UUID is found in crash log
			UUID=$(echo "${i//-/}" | tr 'A-F' 'a-f' | awk '{print $2}')
			if [[ $(grep "$UUID" "$LOG_PATH") ]]; then
				$CRASH -v $ARGS
				break
			else
				echo "UUID is not matched"
			fi
		fi
	done
}

checkUUIDAndExec $1 $2

```